<div class="usuarios-container">
  <!-- Encabezado -->
  <div class="usuarios-header">
    <h2>Gestión de Usuarios</h2>
    <button
      class="tp-btn tp-btn--green"
      (click)="resetForm(); showModal = true"
    >
      + Nuevo Usuario
    </button>
  </div>

  <!-- Tabla -->
  <div class="table-card">
    <table class="tp-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Residencia</th>
          <th>Rol Vecino</th>
          <th>Estado</th>
          <th class="acciones-col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of usuarios">
          <td>{{ u.nombre }}</td>
          <td>{{ u.email }}</td>
          <td>
            {{ getNombreRol(u.rolId) }}
          </td>
          <td>{{ getNombreResidencia(u.residenciaId) }}</td>
          <td>{{ u.rol_vecino || "—" }}</td>

          <td>
            <label class="switch">
              <input
                type="checkbox"
                [checked]="u.estado === 'Activo'"
                (change)="toggleEstado(u)"
              />
              <span class="slider"></span>
            </label>
          </td>
          <td class="acciones">
            <button (click)="editarUsuario(u)" class="icon-btn edit">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button (click)="eliminarUsuario(u.id)" class="icon-btn delete">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="showModal" (click)="showModal = false"></div>
<div class="modal" *ngIf="showModal">
  <div class="modal__head">
    <h3>{{ editando ? "Editar Usuario" : "Nuevo Usuario" }}</h3>
    <button class="icon-btn" (click)="showModal = false">✕</button>
  </div>
  <div class="modal__body">
    <div class="field">
      <label>Nombre</label>
      <input
        type="text"
        [(ngModel)]="nuevoUsuario.nombre"
        placeholder="Ej. Juan Pérez"
      />
    </div>

    <div class="field">
      <label>Email</label>
      <input
        type="email"
        [(ngModel)]="nuevoUsuario.email"
        placeholder="correo@ejemplo.com"
      />
    </div>

    <div class="field">
      <label>Rol</label>
      <ng-select
        [items]="roles"
        bindLabel="nombre"
        bindValue="id"
        [(ngModel)]="nuevoUsuario.rolId"
        [placeholder]="!nuevoUsuario.rolId ? 'Selecciona rol' : ''"
        class="custom-select"
      >
      </ng-select>
    </div>

    <!-- Opcional: Usuario y Password -->
    <div class="field">
      <label>Usuario (opcional)</label>
      <input
        type="text"
        [(ngModel)]="nuevoUsuario.username"
        placeholder="Ej. admin01"
      />
    </div>

    <div class="field">
      <label>Contraseña (opcional)</label>
      <input
        type="password"
        [(ngModel)]="nuevoUsuario.password"
        placeholder="••••••"
      />
    </div>

    <!-- Residencia -->
    <div class="field">
      <label>Residencia</label>
      <ng-select
        [items]="residencias"
        bindLabel="displayName"
        bindValue="id"
        [(ngModel)]="nuevoUsuario.residenciaId"
        [placeholder]="!nuevoUsuario.residenciaId ? 'Selecciona residencia' : ''"
        class="custom-select"
      >
      </ng-select>
    </div>

    <!-- Rol Vecino -->
    <div class="field">
      <label>Rol en residencia</label>
      <select [(ngModel)]="nuevoUsuario.rol_vecino">
        <option value="" disabled selected>Selecciona</option>
        <option *ngFor="let opt of rolVecinoOpciones" [value]="opt">
          {{ opt | titlecase }}
        </option>
      </select>
    </div>

    <div class="field">
      <label>Estado</label>
      <label class="switch">
        <input
          type="checkbox"
          [(ngModel)]="nuevoUsuario.estado"
          [ngModel]="nuevoUsuario.estado === 'Activo'"
          (ngModelChange)="nuevoUsuario.estado = $event ? 'Activo' : 'Inactivo'"
        />
        <span class="slider"></span>
      </label>
    </div>
  </div>
  <div class="modal__foot">
    <button class="tp-btn" (click)="showModal = false">Cancelar</button>
    <button class="tp-btn tp-btn--green" (click)="guardarUsuario()">
      {{ editando ? "Actualizar" : "Agregar" }}
    </button>
  </div>
</div>
